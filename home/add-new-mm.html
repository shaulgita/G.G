<!-- /home/add-new-mm.html -->
<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Add New Member</title>

  <style>
    :root{
      --border:#d7dbe2;
      --muted:#667085;
      --bg:#ffffff;
      --panel:#f6f7f9;
      --text:#111;
      --danger:#b3261e;
      --ok:#137333;
      --radius:16px;
      --pad:14px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family: Arial, sans-serif;
      background: var(--bg); color:var(--text);
    }
    .topbar{
      position: sticky; top:0; z-index:10;
      border-bottom:1px solid var(--border);
      background:#fff;
      padding:12px 16px;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    .brand{ font-weight:900; font-size:18px; }
    .nav a{
      text-decoration:none; color:#111; font-weight:800;
      padding:8px 10px; border-radius:12px; border:1px solid var(--border);
      background:#fff;
    }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 16px 30px;
    }
    .card{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background:#fff;
      padding: 18px;
    }
    h1{ margin:0 0 6px; font-size:28px; }
    .sub{ margin:0 0 14px; color:var(--muted); font-size:14px; line-height:1.5; }

    .section{
      margin-top: 14px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      background: var(--panel);
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 820px){
      .grid{ grid-template-columns: 1fr; }
      .topbar{ flex-direction:column; align-items:stretch; }
      .nav{ display:flex; gap:10px; justify-content:flex-start; flex-wrap:wrap; }
    }

    label{ display:block; font-weight:900; margin-bottom:6px; }
    .req{ color:var(--danger); font-weight:900; }
    input, select, textarea{
      width:100%;
      padding: 12px;
      border:1px solid var(--border);
      border-radius: 14px;
      background:#fff;
      font-size: 15px;
      outline: none;
    }
    textarea{ min-height: 120px; resize: vertical; }
    .hint{ margin-top:6px; color:var(--muted); font-size:12px; }
    .row{ display:flex; gap:10px; align-items:center; }
    .row > *{ flex: 1; }

    .actions{
      display:flex;
      gap:10px;
      margin-top:14px;
      flex-wrap:wrap;
    }
    button{
      border:0;
      border-radius: 16px;
      padding: 12px 16px;
      cursor:pointer;
      font-weight:900;
      font-size: 15px;
    }
    .primary{ background:#111; color:#fff; }
    .ghost{ background:#fff; color:#111; border:1px solid var(--border); }
    .danger{ background:#b3261e; color:#fff; }

    .previewBox{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .previewBox input{
      flex: 1;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
    }

    .msg{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background:#fff;
      display:none;
      line-height: 1.5;
      font-size: 13px;
    }
    .msg.ok{ border-color:#bfe3c7; color: var(--ok); }
    .msg.err{ border-color:#f3c2c2; color: var(--danger); }
    .smallNote{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.5;
    }
    .toggle{
      display:flex; align-items:center; gap:8px;
      margin-top:8px;
      font-size: 12px;
      color: var(--muted);
      user-select:none;
    }
    .toggle input{ width:auto; }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="brand">New Member - Join</div>
    <nav class="nav">
      <a href="index.html">התחברות</a>
      <a href="homepage.html">עמוד ראשי</a>
    </nav>
  </header>

  <main class="wrap">
    <div class="card">
      <h1>הוספת חבר חדש</h1>
      <p class="sub">
        ממלאים פרטים → לוחצים <b>Submit (GitHub Issue)</b> → נפתח דף יצירת Issue בגיטהאב עם JSON מוכן.
        אחרי Submit, ה-Action ייצור קובץ משתמש בתיקייה <b>home/data/new-members</b> לפי המייל (עם מניעת כפילויות).
      </p>

      <!-- Invitation link preview -->
      <div class="section">
        <label>Invitation link preview (English)</label>
        <div class="previewBox">
          <input id="inviteLink" type="text" readonly value="" />
          <button class="ghost" id="copyLinkBtn" type="button">Copy link</button>
          <button class="ghost" id="openLinkBtn" type="button">Open</button>
        </div>
        <div class="hint">הלינק מתעדכן אוטומטית לפי הפרטים שמילאת.</div>
      </div>

      <!-- Form -->
      <div class="section">
        <div class="grid">
          <div>
            <label>שם פרטי <span class="req">*</span></label>
            <input id="firstName" type="text" placeholder="Shaul" required />
          </div>

          <div>
            <label>שם משפחה <span class="req">*</span></label>
            <input id="lastName" type="text" placeholder="Gita" required />
          </div>

          <div>
            <label>מייל <span class="req">*</span></label>
            <input id="email" type="email" placeholder="your@email.com" required />
            <div class="hint">לפי המייל ייקבע שם הקובץ (למשל: your_at_email_com.json)</div>
          </div>

          <div>
            <label>Password <span class="req">*</span></label>
            <input id="password" type="password" minlength="6" placeholder="לפחות 6 תווים" required />
            <div class="toggle">
              <input id="showPass" type="checkbox" />
              <span>הצג סיסמה</span>
            </div>
            <div class="hint">הסיסמה לא נשמרת כטקסט — ה-Action שומר רק Hash+Salt.</div>
          </div>

          <div>
            <label>תחום לימודים <span class="req">*</span></label>
            <input id="fieldOfStudy" type="text" placeholder="Electrical Engineering" required />
          </div>

          <div>
            <label>שנה <span class="req">*</span></label>
            <select id="year" required>
              <option value="" selected disabled>בחר</option>
              <option value="1">שנה 1</option>
              <option value="2">שנה 2</option>
              <option value="3">שנה 3</option>
              <option value="4">שנה 4</option>
              <option value="5+">5+</option>
              <option value="MSc">תואר שני (MSc)</option>
              <option value="PhD">דוקטורט (PhD)</option>
              <option value="Other">אחר</option>
            </select>
          </div>

          <div>
            <label>מקום לימודים <span class="req">*</span></label>
            <input id="institution" type="text" placeholder="Bar-Ilan University" required />
          </div>

          <div>
            <label>קישור לקובץ PDF (CV) <span class="req">*</span></label>
            <input id="cvPdfLink" type="url" placeholder="https://.../cv.pdf" required />
            <div class="hint">בגלל שזה GitHub Pages, חייב להיות קישור (לא העלאת קובץ ישירות).</div>
          </div>

          <div>
            <label>ממוצע ציונים (אופציונלי)</label>
            <input id="gpa" type="text" placeholder="87" />
          </div>

          <div>
            <label>קישור ללינקדאין (אופציונלי)</label>
            <input id="linkedin" type="url" placeholder="https://www.linkedin.com/in/..." />
          </div>

          <div style="grid-column: 1 / -1;">
            <label>פסקה אישית (אופציונלי)</label>
            <textarea id="about" placeholder="ספר/י בקצרה על עצמך..."></textarea>
          </div>
        </div>

        <div class="actions">
          <button class="primary" id="submitBtn" type="button">Submit (GitHub Issue)</button>
          <button class="ghost" id="copyJsonBtn" type="button">Copy JSON</button>
          <button class="danger" id="clearBtn" type="button">נקה טופס</button>
        </div>

        <div id="msg" class="msg"></div>

        <div class="smallNote">
          אם אחרי Submit לא נוצר קובץ: בדוק שב-Issue יש Label בשם <b>new-member</b> ושב-Actions רץ workflow בשם
          <b>Create new member file from Issue</b>.
        </div>
      </div>
    </div>
  </main>

  <script>
    // ====== MUST EDIT IF NEEDED ======
    const GITHUB_OWNER = "shaulgita";     // <-- שנה אם צריך
    const GITHUB_REPO  = "G.G";          // <-- שנה אם צריך
    const ISSUE_TEMPLATE = "new_member.md"; // <-- שם הקובץ שבתיקיית .github/ISSUE_TEMPLATE
    // =================================

    function $(id){ return document.getElementById(id); }

    function showMsg(type, text){
      const box = $("msg");
      box.className = "msg " + (type === "ok" ? "ok" : "err");
      box.textContent = text;
      box.style.display = "block";
    }

    function hideMsg(){
      const box = $("msg");
      box.style.display = "none";
      box.textContent = "";
    }

    function requiredOk(){
      return (
        $("firstName").value.trim() &&
        $("lastName").value.trim() &&
        $("email").value.trim() &&
        $("password").value.trim().length >= 6 &&
        $("fieldOfStudy").value.trim() &&
        $("year").value &&
        $("institution").value.trim() &&
        $("cvPdfLink").value.trim()
      );
    }

    function buildPayload(){
      return {
        email: $("email").value.trim(),
        password: $("password").value,
        firstName: $("firstName").value.trim(),
        lastName: $("lastName").value.trim(),
        fieldOfStudy: $("fieldOfStudy").value.trim(),
        year: $("year").value,
        institution: $("institution").value.trim(),
        cvPdfLink: $("cvPdfLink").value.trim(),
        gpa: $("gpa").value.trim() || null,
        linkedin: $("linkedin").value.trim() || null,
        about: $("about").value.trim() || null
      };
    }

    function buildIssueTitle(payload){
      const fn = payload.firstName || "New";
      const ln = payload.lastName || "Member";
      return `[NEW MEMBER] ${fn} ${ln}`.trim();
    }

    function buildIssueBody(payload){
      // Workflow מחפש JSON בקוד-בלוק. זה הכי יציב:
      const json = JSON.stringify(payload, null, 2);
      return [
        "```json",
        json,
        "```",
        "",
        "_Do not edit the JSON block._"
      ].join("\n");
    }

    function buildInviteLink(){
      hideMsg();

      const payload = buildPayload();
      const title = buildIssueTitle(payload);
      const body = buildIssueBody(payload);

      // Use issue template (recommended)
      // This opens GitHub new issue page with the template selected
      const base = `https://github.com/${encodeURIComponent(GITHUB_OWNER)}/${encodeURIComponent(GITHUB_REPO)}/issues/new`;
      const qs = new URLSearchParams({
        template: ISSUE_TEMPLATE,
        title: title,
        body: body
      });

      return `${base}?${qs.toString()}`;
    }

    function refreshInvite(){
      // Don't block preview even if not all fields filled
      try{
        $("inviteLink").value = buildInviteLink();
      }catch(e){
        $("inviteLink").value = "";
      }
    }

    async function copyToClipboard(text){
      try{
        await navigator.clipboard.writeText(text);
        return true;
      }catch(e){
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        const ok = document.execCommand("copy");
        document.body.removeChild(ta);
        return ok;
      }
    }

    // ===== EVENTS =====
    ["firstName","lastName","email","password","fieldOfStudy","year","institution","cvPdfLink","gpa","linkedin","about"]
      .forEach(id => {
        const el = $(id);
        if (!el) return;
        el.addEventListener("input", refreshInvite);
        el.addEventListener("change", refreshInvite);
      });

    $("showPass").addEventListener("change", () => {
      $("password").type = $("showPass").checked ? "text" : "password";
    });

    $("copyLinkBtn").addEventListener("click", async () => {
      const link = $("inviteLink").value.trim();
      if (!link){
        showMsg("err", "אין לינק להעתקה. מלא קודם שדות.");
        return;
      }
      const ok = await copyToClipboard(link);
      showMsg(ok ? "ok" : "err", ok ? "הועתק לינק." : "לא הצלחתי להעתיק. נסה ידנית.");
    });

    $("openLinkBtn").addEventListener("click", () => {
      const link = $("inviteLink").value.trim();
      if (!link){
        showMsg("err", "אין לינק לפתיחה. מלא קודם שדות.");
        return;
      }
      window.open(link, "_blank", "noopener,noreferrer");
      showMsg("ok", "נפתח דף יצירת Issue בגיטהאב. עכשיו לחץ Submit שם.");
    });

    $("copyJsonBtn").addEventListener("click", async () => {
      if (!requiredOk()){
        showMsg("err", "מלא את כל שדות החובה לפני העתקת JSON (כולל סיסמה).");
        return;
      }
      const payload = buildPayload();
      const json = JSON.stringify(payload, null, 2);
      const wrapped = "```json\n" + json + "\n```";
      const ok = await copyToClipboard(wrapped);
      showMsg(ok ? "ok" : "err", ok ? "הועתק JSON (כולל ```json)." : "לא הצלחתי להעתיק. נסה ידנית.");
    });

    $("submitBtn").addEventListener("click", () => {
      if (!requiredOk()){
        showMsg("err", "חסר משהו בשדות החובה (כולל Password).");
        return;
      }
      const link = buildInviteLink();
      window.open(link, "_blank", "noopener,noreferrer");
      showMsg("ok", "נפתח דף יצירת Issue בגיטהאב. לחץ שם Submit כדי ליצור משתמש.");
    });

    $("clearBtn").addEventListener("click", () => {
      ["firstName","lastName","email","password","fieldOfStudy","year","institution","cvPdfLink","gpa","linkedin","about"]
        .forEach(id => {
          const el = $(id);
          if (!el) return;
          if (el.tagName === "SELECT") el.value = "";
          else el.value = "";
        });
      $("showPass").checked = false;
      $("password").type = "password";
      refreshInvite();
      hideMsg();
    });

    // init
    refreshInvite();
  </script>
</body>
</html>
