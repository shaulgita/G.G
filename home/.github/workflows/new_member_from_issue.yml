name: Create new member file from Issue

on:
  issues:
    types: [opened, labeled, edited]

permissions:
  contents: write
  issues: write

jobs:
  build_member_file:
    if: contains(github.event.issue.labels.*.name, 'new-member')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Parse issue JSON and write member file
        run: |
          python - << 'PY'
          import json, os, re, pathlib, sys, datetime

          event_path = os.environ["GITHUB_EVENT_PATH"]
          with open(event_path, "r", encoding="utf-8") as f:
            event = json.load(f)

          issue = event["issue"]
          body = issue.get("body") or ""

          # Accept ```json ... ``` or ``` ... ```
          m = re.search(r"```(?:json)?\s*(\{.*?\})\s*```", body, re.S | re.I)
          if not m:
            print("No JSON code block found in issue body. Expected ```json {..} ```")
            sys.exit(1)

          payload = json.loads(m.group(1))

          email = (payload.get("email") or "").strip().lower()
          if not email or "@" not in email:
            print("Invalid or missing email in JSON payload.")
            sys.exit(1)

          safe = email.replace("@", "_at_").replace(".", "_")
          safe = re.sub(r"[^a-z0-9_]+", "_", safe)

          base_dir = pathlib.Path("data") / "new-members"
