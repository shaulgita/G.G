<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>×”×¦×¢×ª ××—×™×¨</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
  body { font-family: Arial, sans-serif; margin:16px; background:#fff; }
  .section { border:1px solid #ddd; border-radius:10px; padding:14px; margin-bottom:16px; background:#fafafa; }
  label { display:block; margin-top:10px; font-weight:700; }
  input, select { width:100%; padding:8px; margin-top:4px; border:1px solid #d1d5db; border-radius:8px; }
  button { padding:10px 16px; font-size:15px; border-radius:10px; border:0; cursor:pointer; }
  .primary { background:#1f6feb; color:#fff; }
  .secondary { background:#e5e7eb; }

  table { width:100%; border-collapse:collapse; margin-top:12px; }
  th, td { border-bottom:1px solid #ddd; padding:8px; text-align:right; }
  th { background:#1f2a44; color:#fff; }

  .total { margin-top:14px; font-size:18px; font-weight:800; }
  .delete-btn { background:none; border:none; font-size:18px; cursor:pointer; }

  .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.4); align-items:center; justify-content:center; }
  .modal .box { background:#fff; padding:16px; border-radius:12px; width:min(520px,92vw); }

  /* === PDF === */
  #pdfWrap { display:none; }
  .pdf { direction:rtl; padding:18mm 15mm; font-family:Arial; }
  .pdf table { width:100%; border-collapse:collapse; }
  .pdf th { background:#1f2a44; color:#fff; padding:6px; }
  .pdf td { border:1px solid #ddd; padding:6px; font-size:12px; }

  .pdf-header {
    background:#1f2a44;
    margin:-18mm -15mm 16px -15mm;
    height:95px;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:0;
  }
  .pdf-logo {
    height:98%;
    max-height:100%;
    width:auto;
    object-fit:contain;
  }

  /* LTR isolate for numbers/sizes so RTL won't break slashes and dimensions */
  .ltr { direction:ltr; unicode-bidi:isolate; display:inline-block; }

  /* Business + Customer blocks */
  .pdf-top {
    display:flex;
    justify-content:space-between;
    gap:16px;
    margin:10px 0 8px;
  }
  .pdf-biz, .pdf-cust { width:48%; }
  .pdf-biz { text-align:right; font-size:12px; line-height:1.6; }
  .pdf-biz-line { display:flex; align-items:center; gap:6px; }
  .pdf-biz-ico { width:16px; font-size:12px; opacity:.9; text-align:center; }

  .pdf-cust { text-align:left; font-size:12px; line-height:1.6; }

  .order-row{
    display:flex;
    justify-content:space-between;
    align-items:flex-end;
    margin:10px 0 8px;
  }
  .order-title{
    font-weight:800;
    display:inline-block;
    border-bottom:2px solid #111827;
    padding-bottom:2px;
  }
  .order-id{ font-size:12px; text-align:left; }

  .pdf-note{
    margin-top:10px;
    font-size:11px;
    opacity:.9;
  }

  /* Better page breaking */
  .pdf table { page-break-inside:auto; }
  .pdf tr { page-break-inside:avoid; page-break-after:auto; }

  /* === FIX: table headers on multi-page + stable breaks === */
  .pdf thead { display: table-header-group; }
  .pdf tfoot { display: table-footer-group; }

  /* === NEW: discount controls layout === */
  .tools-row{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
    margin-top:10px;
  }
  .discount-wrap{
    display:flex;
    align-items:center;
    gap:8px;
    padding:8px 10px;
    border:1px solid #d1d5db;
    border-radius:10px;
    background:#fff;
  }
  .discount-wrap label{
    margin:0;
    font-weight:700;
    white-space:nowrap;
  }
  .discount-wrap input{
    width:90px;
    margin:0;
    padding:8px;
    border-radius:10px;
  }

  .totals-box{
    margin-top:10px;
    font-size:14px;
    line-height:1.6;
  }
  .totals-line{
    display:flex;
    justify-content:space-between;
    gap:12px;
  }

  /* NEW: make payable line bigger */
  .payable-line strong{ font-size:22px; font-weight:900; }

  /* NEW: PDF summary / payable */
  .pdf-summary{
    margin-top:6px;
    font-size:12px;
    line-height:1.6;
  }
  .pdf-payable{
    margin-top:8px;
    font-size:22px;
    font-weight:900;
  }

  /* ×¡×”×´×› ×¨×’×™×œ ×§×˜×Ÿ ×•×œ× ××•×“×’×© */
  .pdf-subtotal{
    font-size:16px;
    font-weight:400;
    margin:8px 0;
    white-space:nowrap;
  }
  .ltr{
    direction:ltr;
    unicode-bidi:isolate;
    display:inline-block;
  }

  /* === ALIGN FIX (PDF + Screen) === */
  .totals-line{
    display:flex;
    align-items:baseline;
    justify-content:space-between;
    gap:16px;
  }
  .totals-line > span{
    white-space:nowrap;
  }
  .payable-line{
    margin-inline-start:auto;
  }

  .pdf-subtotal,
  .pdf-summary,
  .pdf-payable{
    display:flex;
    align-items:baseline;
    justify-content:space-between;
    gap:16px;
    white-space:nowrap;
  }

  .pdf-subtotal .ltr,
  .pdf-summary .ltr,
  .pdf-payable .ltr{
    white-space:nowrap;
  }

  /* === Mobile fix (SCREEN only) === */
  @media (max-width: 600px) {
    body { margin: 12px; }
    * { max-width: 100%; }

    .section table { display: block; overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .section table thead,
    .section table tbody,
    .section table tr { width: max-content; }

    .totals-line { flex-direction: column; align-items: flex-start; }
    .totals-line > span { white-space: normal; }
    .payable-line { margin-inline-start: 0; }

    .discount-wrap input { width: 110px; }
  }
</style>
</head>

<body>

<h2>×”×¤×§×ª ×”×¦×¢×ª ××—×™×¨</h2>

<div class="section">
  <h3>×¤×¨×˜×™ ×œ×§×•×—</h3>
  <label>×©× ×œ×§×•×— <input id="customerName"></label>
  <label>× ×™×™×“ <input id="customerId"></label>
  <label>××™×™×œ <input id="customerEmail" type="email"></label>

  <!-- âœ… ×—×“×©: ××¡×¤×¨ ×”×–×× ×” ×™×“× ×™ -->
  <label>××¡×¤×¨ ×”×–×× ×” <input id="orderIdInput" placeholder="×”×§×œ×“ ××¡×¤×¨ ×”×–×× ×” (××•×¤×¦×™×•× ×œ×™)"></label>
</div>

<div class="section">
  <h3>×¤×¨×™×˜×™×</h3>
  <button class="primary" onclick="openModal()">â• ×”×•×¡×£ ×¤×¨×™×˜</button>

  <table>
    <thead>
      <tr>
        <th>×¤×¨×™×˜</th>
        <th>×™×“×™×™×</th>
        <th>×›××•×ª</th>
        <th>××•×¨×š&nbsp;×™×—×™×“×”</th>
        <th>××•×¨×š&nbsp;×›×•×œ×œ</th>
        <th>××—×™×¨</th>
        <th>××—×™×§×”</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <div class="total">
    ×¡×”×´×›&nbsp;: â‚ª <span id="grandTotal">0.00</span>
  </div>

  <div class="totals-box">
    <div class="totals-line">
      <span>
        ×¡×š&nbsp;×”× ×—×”&nbsp;:
        <span class="ltr"><span id="discountPctView">0</span>%</span>
        &nbsp;|&nbsp;
        â‚ª <span id="discountAmount">0.00</span>
      </span>
      <span class="payable-line">
        <strong>&nbsp;×¡×”×´×›&nbsp;×œ×ª×©×œ×•×&nbsp;: â‚ª <span id="payableTotal">0.00</span></strong>
      </span>
    </div>
  </div>

  <div class="tools-row">
    <button class="primary" style="margin-top:12px" onclick="generatePDF()">ğŸ“„ ×”×¤×§ ×”×¦×¢×ª ××—×™×¨</button>
  </div>
</div>

<div class="modal" id="modal">
  <div class="box">
    <h3>×”×•×¡×¤×ª ×¤×¨×™×˜</h3>

    <label>×¤×¨×™×˜
      <select id="item"></select>
    </label>

    <label>×¡×•×’ ×¦×‘×¢
      <select id="color">
        <option value="semi">×—×¦×™ ×©×§×•×£</option>
        <option value="solid">××˜×•×</option>
      </select>
    </label>

    <label>××¡×¤×¨ ×™×“×™×™×
      <select id="hands">
        <option value="1">×™×“ ××—×ª (60%)</option>
        <option value="2" selected>2 ×™×“×™×™× (100%)</option>
        <option value="3">3 ×™×“×™×™× (140%)</option>
      </select>
    </label>

    <label>×›××•×ª ×™×—×™×“×•×ª
      <input id="qty" type="number" min="1">
    </label>

    <label>××•×¨×š ×™×—×™×“×” (××³)
      <input id="len" type="number" step="0.01" min="0">
    </label>

    <div style="margin-top:12px">
      <button class="primary" onclick="addRow()">×”×•×¡×£</button>
      <button class="secondary" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<div id="pdfWrap">
  <div id="pdfContent" class="pdf">

    <div class="pdf-header">
      <img src="logo.png" class="pdf-logo" crossorigin="anonymous" alt="logo">
    </div>

    <h2 style="text-align:center">×”×¦×¢×ª&nbsp;××—×™×¨</h2>

    <div class="pdf-top">
      <div class="pdf-biz">
        <div class="pdf-biz-line"><span class="pdf-biz-ico">ğŸ¢</span><span>×’.×’&nbsp;×¤×ª×¨×•× ×•×ª&nbsp;×œ×¢×¥</span></div>
        <div class="pdf-biz-line"><span class="pdf-biz-ico">ğŸ“</span><span class="ltr">050-669-0899</span></div>
        <div class="pdf-biz-line"><span class="pdf-biz-ico">ğŸ“</span><span>××‘×Ÿ&nbsp;×™×”×•×“×”</span></div>
      </div>

      <div class="pdf-cust">
        <div><strong>:&nbsp;×©×&nbsp;×œ×§×•×—</strong> <span id="pdfName"></span></div>
        <div><strong>:&nbsp;××¡×³&nbsp;×¤×œ××¤×•×Ÿ&nbsp;×œ×§×•×—</strong> <span id="pdfId"></span></div>
        <div><strong>:&nbsp;××™×™×œ</strong> <span id="pdfEmail"></span></div>
        <div><strong>:&nbsp;×ª××¨×™×š</strong> <span id="pdfDate"></span></div>
      </div>
    </div>

    <div class="order-row">
      <div class="order-title">×¤×¨×˜×™&nbsp;×”×–×× ×”</div>
      <div class="order-id">
        <strong>:&nbsp;××¡×¤×¨&nbsp;×”×–×× ×”</strong> <span id="pdfOrderId" class="ltr"></span>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>×¤×¨×™×˜</th>
          <th>×™×“×™×™×</th>
          <th>×›××•×ª</th>
          <th>××•×¨×š&nbsp;×™×—×™×“×”</th>
          <th>××•×¨×š&nbsp;×›×•×œ×œ</th>
          <th>××—×™×¨</th>
        </tr>
      </thead>
      <tbody id="pdfTable"></tbody>
    </table>

    <h3 class="pdf-subtotal">
      <span>:&nbsp;×¡×”×´×›</span>
      <span class="ltr">â‚ª <span id="pdfTotal"></span></span>
    </h3>

    <div class="pdf-summary">
      <span>:&nbsp;×¡×š&nbsp;×”× ×—×” </span>
      <span class="ltr">(<span id="pdfDiscountPct">0</span>%) â‚ª <span id="pdfDiscount">0.00</span></span>
    </div>

    <div class="pdf-payable">
      <span><strong>:&nbsp;×¡×”×´×›&nbsp;×œ×ª×©×œ×•× </strong></span>
      <span class="ltr">â‚ª <span id="pdfPayable">0.00</span></span>
    </div>

    <div class="pdf-note">×”××—×™×¨×™×&nbsp;××™× ×&nbsp;×›×•×œ×œ×™×&nbsp;××¢×´×&nbsp;*</div>
  </div>
</div>

<script>
  // ==== DOM Refs ====
  const customerName  = document.getElementById("customerName");
  const customerId    = document.getElementById("customerId");
  const customerEmail = document.getElementById("customerEmail");

  // âœ… ×—×“×©: ××¡×¤×¨ ×”×–×× ×” ×™×“× ×™
  const orderIdInput  = document.getElementById("orderIdInput");

  const pdfName  = document.getElementById("pdfName");
  const pdfId    = document.getElementById("pdfId");
  const pdfEmail = document.getElementById("pdfEmail");
  const pdfDate  = document.getElementById("pdfDate");
  const pdfTotal = document.getElementById("pdfTotal");
  const pdfOrderId = document.getElementById("pdfOrderId");

  const pdfDiscount = document.getElementById("pdfDiscount");
  const pdfPayable  = document.getElementById("pdfPayable");
  const pdfDiscountPct = document.getElementById("pdfDiscountPct");

  const pdfWrap  = document.getElementById("pdfWrap");
  const modal    = document.getElementById("modal");

  const discountAmountEl = document.getElementById("discountAmount");
  const payableTotalEl = document.getElementById("payableTotal");
  const discountPctViewEl = document.getElementById("discountPctView");

  // ==== Helpers ====
  function formatItemHTML(text) {
    let s = String(text || "").replace(/\s+/g, " ").trim();
    s = s.replace(/([\u0590-\u05FF])(\d)/g, "$1 $2");
    s = s.replace(/([\u0590-\u05FFA-Za-z])\s*\/\s*([\u0590-\u05FFA-Za-z])/gu, "$1 \u200F/\u200F $2");
    s = s.replace(/(\d+)\s*\/\s*(\d+)/g, '<span class="ltr">$1/$2</span>');
    s = s.replace(/(\d+)\s*[xÃ—]\s*(\d+)/gi, '<span class="ltr">$1Ã—$2</span>');
    return s;
  }

  // ××¡×¤×¨ ×”×–×× ×” ×§×¦×¨ (5 ×ª×•×•×™×)
  function makeOrderId() {
    const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; // ×‘×œ×™ O/0, I/1
    const n = 5;
    const arr = new Uint32Array(n);
    crypto.getRandomValues(arr);
    let out = "";
    for (let i = 0; i < n; i++) out += chars[arr[i] % chars.length];
    return out;
  }

  function waitForImages(el){
    const imgs = Array.from(el.querySelectorAll("img"));
    return Promise.all(imgs.map(img => {
      if (img.complete && img.naturalWidth > 0) return Promise.resolve();
      return new Promise(resolve => {
        img.onload = () => resolve();
        img.onerror = () => resolve();
      });
    }));
  }

  // ==== Data ====
  const PRICE_LIST = {
    "×œ×˜×” / ×”×¦×œ×œ×” 20Ã—45": { semi: 4.50, solid: 4.70 },
    "×œ×•×— ×¦×•×œ ×¢×œ 7 20Ã—75": { semi: 4.80, solid: 5.00 },
    "×œ×•×— ×¦×•×œ ×¢×œ 10 20Ã—95": { semi: 5.20, solid: 5.50 },
    "×œ×•×— ×¦×•×œ ×¢×œ 15 20Ã—145": { semi: 6.30, solid: 6.50 },
    "×œ×•×— ×¦×•×œ ×¢×œ 20 20Ã—195": { semi: 7.30, solid: 7.50 },
    "×œ×•×— ×¦×™×¤×•×™ × ×•×˜×¤××“×¨ 14Ã—1.5": { semi: 4.50, solid: 4.70 },
    "×œ×•×— ×’×œ×¨×™×” ×¦×‘×™×¢×” ××œ× 140Ã—20": { semi: 6.30, solid: 6.50 },
    "×œ×•×— ×’×œ×¨×™×” ×¦×‘×™×¢×” ×—×œ×§×™×ª 140Ã—20": { semi: 4.80, solid: 5.00 },

    "×§×•×¨×” 3/5 32Ã—45": { semi: 4.60, solid: 4.80 },
    "×—×¦×™ ×“×§ 32Ã—70": { semi: 5.00, solid: 5.20 },
    "×§×•×¨×” 3/10 32Ã—95": { semi: 5.50, solid: 5.70 },
    "×œ×•×— ×“×§ 32Ã—145": { semi: 6.50, solid: 6.70 },
    "×§×•×¨×” 3/20 32Ã—195": { semi: 7.50, solid: 7.70 },

    "×§×•×¨×” 5/5 45Ã—45": { semi: 4.80, solid: 5.00 },
    "×§×•×¨×” 5/7 45Ã—70": { semi: 5.30, solid: 5.50 },
    "×§×•×¨×” 5/10 45Ã—95": { semi: 5.80, solid: 6.00 },
    "×§×•×¨×” 5/15 45Ã—145": { semi: 6.80, solid: 7.00 },
    "×§×•×¨×” 5/20 45Ã—195": { semi: 7.80, solid: 8.00 },

    "80/80 70Ã—70": { semi: 5.80, solid: 6.00 },
    "150/80 145Ã—70": { semi: 7.30, solid: 7.50 },
    "200/80 195Ã—70": { semi: 5.70, solid: 5.90 },

    "100/100 85Ã—85": { semi: 6.40, solid: 6.60 },
    "100/150 145Ã—85": { semi: 7.60, solid: 7.80 },
    "100/200 195Ã—85": { semi: 8.60, solid: 8.80 },
    "100/250 240Ã—85": { semi: 9.50, solid: 9.70 },
    "100/300 280Ã—85": { semi: 10.50, solid: 10.70 },

    "150/150 135Ã—135": { semi: 8.40, solid: 8.60 },
    "150/200 185Ã—135": { semi: 9.40, solid: 9.60 },
    "150/250 235Ã—135": { semi: 12.50, solid: 12.70 },
    "150/300 280Ã—135": { semi: 13.20, solid: 13.50 },

    "200/200 185Ã—185": { semi: 10.40, solid: 10.60 },
    "200/250 235Ã—185": { semi: 13.40, solid: 13.60 },
    "200/300 280Ã—185": { semi: 14.30, solid: 14.50 }
  };

  const HANDS_FACTOR = { 1:0.6, 2:1.0, 3:1.4 };
  const EXTRA_TINT = { name: "×©×™× ×•×™&nbsp;×’×•×•×Ÿ", price: 500 };

  // ==== State ====
  let total = 0;
  let discountPct = 0;
  const tbody = document.getElementById("tableBody");
  const itemSelect = document.getElementById("item");

  Object.keys(PRICE_LIST).forEach(name => {
    const o = document.createElement("option");
    o.value = name;
    o.textContent = name;
    itemSelect.appendChild(o);
  });

  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
  function calcDiscountAmount(){
    const pct = clamp(Number(discountPct) || 0, 0, 100);
    return total * (pct / 100);
  }
  function calcPayable(){ return total - calcDiscountAmount(); }

  function updateTotalsUI(){
    document.getElementById("grandTotal").innerText = total.toFixed(2);

    const pct = clamp(Number(discountPct) || 0, 0, 100);
    const disc = calcDiscountAmount();

    discountPctViewEl.innerText = pct.toFixed(pct % 1 === 0 ? 0 : 2);
    discountAmountEl.innerText = disc.toFixed(2);
    payableTotalEl.innerText = calcPayable().toFixed(2);
  }

  function openModal(){ modal.style.display="flex"; }
  function closeModal(){ modal.style.display="none"; }

  function addRow(){
    const item = itemSelect.value;
    const colorVal = document.getElementById("color").value;
    const hands = Number(document.getElementById("hands").value);
    const qty = Number(document.getElementById("qty").value);
    const len = Number(document.getElementById("len").value);

    if(qty<=0 || len<=0){ alert("× × ×œ×”×–×™×Ÿ ×¢×¨×›×™× ×ª×§×™× ×™×"); return; }

    const pricePerMeter = PRICE_LIST[item][colorVal];
    const totalMeters = qty * len;
    const rowPrice = totalMeters * pricePerMeter * HANDS_FACTOR[hands];

    total += rowPrice;
    updateTotalsUI();

    const tr = document.createElement("tr");
    tr.dataset.price = String(rowPrice);
    tr.dataset.item = item;
    tr.dataset.hands = String(hands);
    tr.dataset.qty = String(qty);
    tr.dataset.len = String(len);
    tr.dataset.meters = String(totalMeters.toFixed(2));

    tr.innerHTML = `
      <td dir="rtl">${formatItemHTML(item)}</td>
      <td>${hands}</td>
      <td>${qty}</td>
      <td>${len}</td>
      <td>${totalMeters.toFixed(2)}</td>
      <td>${rowPrice.toFixed(2)}</td>
      <td><button class="delete-btn" title="××—×™×§×”">ğŸ—‘ï¸</button></td>
    `;

    tr.querySelector(".delete-btn").onclick = () => {
      total -= Number(tr.dataset.price || "0");
      updateTotalsUI();
      tr.remove();
    };

    tbody.appendChild(tr);
    closeModal();
  }

  (function addTintAndDiscountControls(){
    const addBtn = document.querySelector('button.primary[onclick="openModal()"]');

    const tintBtn = document.createElement("button");
    tintBtn.className = "secondary";
    tintBtn.style.marginInlineStart = "10px";
    tintBtn.textContent = "ğŸ¨ ×©×™× ×•×™ ×’×•×•×Ÿ (+500â‚ª)";
    tintBtn.onclick = () => {
      const exists = [...tbody.querySelectorAll("tr")].some(r => r.dataset.type === "tint");
      if (exists) return;

      const tr = document.createElement("tr");
      tr.dataset.type = "tint";
      tr.dataset.price = String(EXTRA_TINT.price);
      tr.dataset.item = EXTRA_TINT.name;

      total += EXTRA_TINT.price;
      updateTotalsUI();

      tr.innerHTML = `
        <td dir="rtl">${EXTRA_TINT.name}</td>
        <td>â€”</td>
        <td>1</td>
        <td>â€”</td>
        <td>â€”</td>
        <td>${EXTRA_TINT.price.toFixed(2)}</td>
        <td><button class="delete-btn" title="××—×™×§×”">ğŸ—‘ï¸</button></td>
      `;

      tr.querySelector(".delete-btn").onclick = () => {
        total -= EXTRA_TINT.price;
        updateTotalsUI();
        tr.remove();
      };

      tbody.prepend(tr);
    };

    const discountBox = document.createElement("div");
    discountBox.className = "discount-wrap";
    discountBox.innerHTML = `
      <label for="discountPct">×”× ×—×”</label>
      <input id="discountPct" type="number" inputmode="decimal" min="0" max="100" step="0.01" placeholder="0">
      <span class="ltr">%</span>
    `;

    const discountInput = discountBox.querySelector("#discountPct");
    discountInput.addEventListener("input", () => {
      const val = Number(discountInput.value);
      discountPct = clamp(isNaN(val) ? 0 : val, 0, 100);
      updateTotalsUI();
    });

    addBtn.insertAdjacentElement("afterend", tintBtn);
    tintBtn.insertAdjacentElement("afterend", discountBox);

    updateTotalsUI();
  })();

  async function generatePDF(){
    pdfName.innerText  = customerName.value  || "â€”";
    pdfId.innerText    = customerId.value    || "â€”";
    pdfEmail.innerText = customerEmail.value || "â€”";
    pdfDate.innerText  = new Date().toLocaleDateString("he-IL");

    // âœ… ×—×“×©: ×× ×”×•×§×œ×“ ××¡×¤×¨ ×”×–×× ×” ×™×“× ×™ â€“ ×”×©×ª××© ×‘×•. ××—×¨×ª ×¦×•×¨ ××•×˜×•××˜×™.
    const manualOrderId = (orderIdInput.value || "").trim();
    pdfOrderId.innerText = manualOrderId ? manualOrderId : makeOrderId();

    pdfTotal.innerText = total.toFixed(2);

    const pct = clamp(Number(discountPct) || 0, 0, 100);
    const disc = calcDiscountAmount();
    const payable = calcPayable();

    pdfDiscount.innerText = disc.toFixed(2);
    pdfPayable.innerText = payable.toFixed(2);
    pdfDiscountPct.innerText = (pct % 1 === 0 ? String(pct.toFixed(0)) : String(pct.toFixed(2)));

    const pdfTable = document.getElementById("pdfTable");
    pdfTable.innerHTML = "";

    document.querySelectorAll("#tableBody tr").forEach(row => {
      const tr = document.createElement("tr");

      if (row.dataset.type === "tint") {
        tr.innerHTML = `
          <td dir="rtl">${row.dataset.item}</td>
          <td>â€”</td>
          <td>1</td>
          <td>â€”</td>
          <td>â€”</td>
          <td>${Number(row.dataset.price).toFixed(2)}</td>
        `;
        pdfTable.appendChild(tr);
        return;
      }

      const item   = row.dataset.item || "";
      const hands  = row.dataset.hands || "";
      const qty    = row.dataset.qty || "";
      const len    = row.dataset.len || "";
      const meters = row.dataset.meters || "";
      const price  = Number(row.dataset.price || "0").toFixed(2);

      tr.innerHTML = `
        <td dir="rtl">${formatItemHTML(item)}</td>
        <td>${hands}</td>
        <td>${qty}</td>
        <td>${len}</td>
        <td>${meters}</td>
        <td>${price}</td>
      `;
      pdfTable.appendChild(tr);
    });

    pdfWrap.style.display = "block";
    pdfWrap.style.position = "fixed";
    pdfWrap.style.left = "-10000px";
    pdfWrap.style.top = "0";

    const element = document.getElementById("pdfContent");
    const filename = `×”×¦×¢×ª_××—×™×¨_${pdfOrderId.innerText}.pdf`;

    try {
      await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));
      await waitForImages(element);

      await html2pdf()
        .set({
          filename,
          margin: 0,
          pagebreak: { mode: ["css", "legacy"] },
          jsPDF: { unit: "mm", format: "a4", orientation: "portrait", compress: true },
          image: { type: "jpeg", quality: 0.95 },
          html2canvas: {
            scale: 1.5,
            useCORS: true,
            backgroundColor: "#ffffff",
            scrollY: 0
          }
        })
        .from(element)
        .save();
    } finally {
      pdfWrap.style.display = "none";
    }
  }

  window.openModal = openModal;
  window.closeModal = closeModal;
  window.addRow = addRow;
  window.generatePDF = generatePDF;
</script>

</body>
</html>
