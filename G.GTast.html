<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>×”×¦×¢×ª ××—×™×¨</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
  body { font-family: Arial, sans-serif; margin:16px; background:#fff; }
  .section { border:1px solid #ddd; border-radius:10px; padding:14px; margin-bottom:16px; background:#fafafa; }
  label { display:block; margin-top:10px; font-weight:700; }
  input, select { width:100%; padding:8px; margin-top:4px; border:1px solid #d1d5db; border-radius:8px; }
  button { padding:10px 16px; font-size:15px; border-radius:10px; border:0; cursor:pointer; }
  .primary { background:#1f6feb; color:#fff; }
  .secondary { background:#e5e7eb; }

  table { width:100%; border-collapse:collapse; margin-top:12px; }
  th, td { border-bottom:1px solid #ddd; padding:8px; text-align:right; }
  th { background:#1f2a44; color:#fff; }

  .total { margin-top:14px; font-size:18px; font-weight:800; }
  .delete-btn { background:none; border:none; font-size:18px; cursor:pointer; }

  .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,.4); align-items:center; justify-content:center; }
  .modal .box { background:#fff; padding:16px; border-radius:12px; width:min(520px,92vw); }

  /* === PDF === */
  #pdfWrap { display:none; }
  .pdf { direction:rtl; padding:18mm 15mm; font-family:Arial; }
  .pdf table { width:100%; border-collapse:collapse; }
  .pdf th { background:#1f2a44; color:#fff; padding:6px; }
  .pdf td { border:1px solid #ddd; padding:6px; font-size:12px; }

  .pdf-header {
    background:#1f2a44;
    margin:-18mm -15mm 16px -15mm;
    height:95px;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:0;
  }
  .pdf-logo {
    height:98%;
    max-height:100%;
    width:auto;
    object-fit:contain;
  }

  /* LTR isolate for numbers/sizes so RTL won't break slashes and dimensions */
  .ltr { direction:ltr; unicode-bidi:isolate; display:inline-block; }

  /* Business + Customer blocks */
  .pdf-top {
    display:flex;
    justify-content:space-between;
    gap:16px;
    margin:10px 0 8px;
  }
  .pdf-biz, .pdf-cust { width:48%; }
  .pdf-biz { text-align:right; font-size:12px; line-height:1.6; }
  .pdf-biz-line { display:flex; align-items:center; gap:6px; }
  .pdf-biz-ico { width:16px; font-size:12px; opacity:.9; text-align:center; }

  .pdf-cust { text-align:left; font-size:12px; line-height:1.6; }

  .order-row{
    display:flex;
    justify-content:space-between;
    align-items:flex-end;
    margin:10px 0 8px;
  }
  .order-title{
    font-weight:800;
    display:inline-block;
    border-bottom:2px solid #111827;
    padding-bottom:2px;
  }
  .order-id{ font-size:12px; text-align:left; }

  .pdf-note{
    margin-top:10px;
    font-size:11px;
    opacity:.9;
  }

  /* Better page breaking */
  .pdf table { page-break-inside:auto; }
  .pdf tr { page-break-inside:avoid; page-break-after:auto; }
</style>
</head>

<body>

<h2>×”×¤×§×ª ×”×¦×¢×ª ××—×™×¨</h2>

<div class="section">
  <h3>×¤×¨×˜×™ ×œ×§×•×—</h3>
  <label>×©× ×œ×§×•×— <input id="customerName"></label>
  <label>××¡×¤×¨ ×œ×§×•×— <input id="customerId"></label>
  <label>××™×™×œ <input id="customerEmail" type="email"></label>
</div>

<div class="section">
  <h3>×¤×¨×™×˜×™×</h3>
  <button class="primary" onclick="openModal()">â• ×”×•×¡×£ ×¤×¨×™×˜</button>

  <table>
    <thead>
      <tr>
        <th>×¤×¨×™×˜</th>
        <th>×™×“×™×™×</th>
        <th>×›××•×ª</th>
        <th>××•×¨×š&nbsp;×™×—×™×“×”</th>
        <th>××•×¨×š&nbsp;×›×•×œ×œ</th>
        <th>××—×™×¨</th>
        <th>××—×™×§×”</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <div class="total">
    ×¡×”×´×›: â‚ª <span id="grandTotal">0.00</span>
  </div>

  <button class="primary" style="margin-top:12px" onclick="generatePDF()">ğŸ“„ ×”×¤×§ ×”×¦×¢×ª ××—×™×¨</button>
</div>

<!-- ××•×“××œ -->
<div class="modal" id="modal">
  <div class="box">
    <h3>×”×•×¡×¤×ª ×¤×¨×™×˜</h3>

    <label>×¤×¨×™×˜
      <select id="item"></select>
    </label>

    <label>×¡×•×’ ×¦×‘×¢
      <select id="color">
        <option value="semi">×—×¦×™ ×©×§×•×£</option>
        <option value="solid">××˜×•×</option>
      </select>
    </label>

    <label>××¡×¤×¨ ×™×“×™×™×
      <select id="hands">
        <option value="1">×™×“ ××—×ª (60%)</option>
        <option value="2" selected>2 ×™×“×™×™× (100%)</option>
        <option value="3">3 ×™×“×™×™× (140%)</option>
      </select>
    </label>

    <label>×›××•×ª ×™×—×™×“×•×ª
      <input id="qty" type="number" min="1">
    </label>

    <label>××•×¨×š ×™×—×™×“×” (××³)
      <input id="len" type="number" step="0.01" min="0">
    </label>

    <div style="margin-top:12px">
      <button class="primary" onclick="addRow()">×”×•×¡×£</button>
      <button class="secondary" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<!-- PDF -->
<div id="pdfWrap">
  <div id="pdfContent" class="pdf">

    <div class="pdf-header">
      <img src="logo.png" class="pdf-logo" crossorigin="anonymous" alt="logo">
    </div>

    <h2 style="text-align:center">×”×¦×¢×ª&nbsp;××—×™×¨</h2>

    <div class="pdf-top">
      <!-- ×¦×“ ×™××™×Ÿ: ×¤×¨×˜×™ ×”×¢×¡×§ -->
      <div class="pdf-biz">
        <div class="pdf-biz-line"><span class="pdf-biz-ico">ğŸ¢</span><span>×’.×’ ×¤×ª×¨×•× ×•×ª ×œ×¢×¥</span></div>
        <div class="pdf-biz-line"><span class="pdf-biz-ico">ğŸ“</span><span class="ltr">050-669-0899</span></div>
        <div class="pdf-biz-line"><span class="pdf-biz-ico">ğŸ“</span><span>××‘×Ÿ ×™×”×•×“×”</span></div>
      </div>

      <!-- ×¦×“ ×©×××œ: ×¤×¨×˜×™ ×”×œ×§×•×— -->
      <div class="pdf-cust">
        <div><strong>×©× ×œ×§×•×—:</strong> <span id="pdfName"></span></div>
        <div><strong>××¡×³ ×œ×§×•×—:</strong> <span id="pdfId"></span></div>
        <div><strong>××™×™×œ:</strong> <span id="pdfEmail"></span></div>
        <div><strong>×ª××¨×™×š:</strong> <span id="pdfDate"></span></div>
      </div>
    </div>

    <div class="order-row">
      <div class="order-title">×¤×¨×˜×™ ×”×–×× ×”</div>
      <div class="order-id">
        <strong>××¡×¤×¨ ×”×–×× ×”:</strong> <span id="pdfOrderId" class="ltr"></span>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>×¤×¨×™×˜</th>
          <th>×™×“×™×™×</th>
          <th>×›××•×ª</th>
          <th>××•×¨×š&nbsp;×™×—×™×“×”</th>
          <th>××•×¨×š&nbsp;×›×•×œ×œ</th>
          <th>××—×™×¨</th>
        </tr>
      </thead>
      <tbody id="pdfTable"></tbody>
    </table>

    <h3>×¡×”×´×›: â‚ª <span id="pdfTotal"></span></h3>
    <div class="pdf-note">* ×”××—×™×¨×™× ××™× × ×›×•×œ×œ×™× ××¢×´×</div>

  </div>
</div>

<script>
  // ==== DOM Refs ====
  const customerName  = document.getElementById("customerName");
  const customerId    = document.getElementById("customerId");
  const customerEmail = document.getElementById("customerEmail");

  const pdfName  = document.getElementById("pdfName");
  const pdfId    = document.getElementById("pdfId");
  const pdfEmail = document.getElementById("pdfEmail");
  const pdfDate  = document.getElementById("pdfDate");
  const pdfTotal = document.getElementById("pdfTotal");
  const pdfOrderId = document.getElementById("pdfOrderId");

  const pdfWrap  = document.getElementById("pdfWrap");
  const modal    = document.getElementById("modal");

  // ==== Helpers ====
  function formatItemHTML(text) {
    let s = String(text || "").replace(/\s+/g, " ").trim();

    // Add space between Hebrew and number: ×”×¦×œ×œ×”20Ã—45 => ×”×¦×œ×œ×” 20Ã—45
    s = s.replace(/([\u0590-\u05FF])(\d)/g, "$1 $2");

    // Slash between words (Heb/Eng) - keep in place in RTL
    s = s.replace(
      /([\u0590-\u05FFA-Za-z])\s*\/\s*([\u0590-\u05FFA-Za-z])/gu,
      "$1 \u200F/\u200F $2"
    );

    // Numeric fraction 80/80 (no spaces) and isolate LTR
    s = s.replace(/(\d+)\s*\/\s*(\d+)/g, '<span class="ltr">$1/$2</span>');

    // Dimensions 70Ã—70 or 70x70 (no spaces) and isolate LTR
    s = s.replace(/(\d+)\s*[xÃ—]\s*(\d+)/gi, '<span class="ltr">$1Ã—$2</span>');

    return s;
  }

  function makeOrderId() {
    const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    const randLetters = (n) => {
      const arr = new Uint32Array(n);
      crypto.getRandomValues(arr);
      return [...arr].map(x => letters[x % letters.length]).join("");
    };

    const d = new Date();
    const y = String(d.getFullYear()).slice(-2);
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    const datePart = `${y}${m}${day}`;

    const num1 = Math.floor(100 + Math.random() * 900);
    const num2 = Math.floor(1000 + Math.random() * 9000);

    return `GG-${randLetters(2)}${num1}-${datePart}-${num2}`;
  }

  // ==== Data ====
  const PRICE_LIST = {
    "×œ×˜×” / ×”×¦×œ×œ×” 20Ã—45": { semi: 4.50, solid: 4.70 },
    "×œ×•×— ×¦×•×œ ×¢×œ 7 20Ã—75": { semi: 4.80, solid: 5.00 },
    "×œ×•×— ×¦×•×œ ×¢×œ 10 20Ã—95": { semi: 5.20, solid: 5.50 },
    "×œ×•×— ×¦×•×œ ×¢×œ 15 20Ã—145": { semi: 6.30, solid: 6.50 },
    "×œ×•×— ×¦×•×œ ×¢×œ 20 20Ã—195": { semi: 7.30, solid: 7.50 },
    "×œ×•×— ×¦×™×¤×•×™ × ×•×˜×¤××“×¨ 14Ã—1.5": { semi: 4.50, solid: 4.70 },
    "×œ×•×— ×’×œ×¨×™×” ×¦×‘×™×¢×” ××œ× 140Ã—20": { semi: 6.30, solid: 6.50 },
    "×œ×•×— ×’×œ×¨×™×” ×¦×‘×™×¢×” ×—×œ×§×™×ª 140Ã—20": { semi: 4.80, solid: 5.00 },

    "×§×•×¨×” 3/5 32Ã—45": { semi: 4.60, solid: 4.80 },
    "×—×¦×™ ×“×§ 32Ã—70": { semi: 5.00, solid: 5.20 },
    "×§×•×¨×” 3/10 32Ã—95": { semi: 5.50, solid: 5.70 },
    "×œ×•×— ×“×§ 32Ã—145": { semi: 6.50, solid: 6.70 },
    "×§×•×¨×” 3/20 32Ã—195": { semi: 7.50, solid: 7.70 },

    "×§×•×¨×” 5/5 45Ã—45": { semi: 4.80, solid: 5.00 },
    "×§×•×¨×” 5/7 45Ã—70": { semi: 5.30, solid: 5.50 },
    "×§×•×¨×” 5/10 45Ã—95": { semi: 5.80, solid: 6.00 },
    "×§×•×¨×” 5/15 45Ã—145": { semi: 6.80, solid: 7.00 },
    "×§×•×¨×” 5/20 45Ã—195": { semi: 7.80, solid: 8.00 },

    "80/80 70Ã—70": { semi: 5.80, solid: 6.00 },
    "150/80 145Ã—70": { semi: 7.30, solid: 7.50 },
    "200/80 195Ã—70": { semi: 5.70, solid: 5.90 },

    "100/100 85Ã—85": { semi: 6.40, solid: 6.60 },
    "100/150 145Ã—85": { semi: 7.60, solid: 7.80 },
    "100/200 195Ã—85": { semi: 8.60, solid: 8.80 },
    "100/250 240Ã—85": { semi: 9.50, solid: 9.70 },
    "100/300 280Ã—85": { semi: 10.50, solid: 10.70 },

    "150/150 135Ã—135": { semi: 8.40, solid: 8.60 },
    "150/200 185Ã—135": { semi: 9.40, solid: 9.60 },
    "150/250 235Ã—135": { semi: 12.50, solid: 12.70 },
    "150/300 280Ã—135": { semi: 13.20, solid: 13.50 },

    "200/200 185Ã—185": { semi: 10.40, solid: 10.60 },
    "200/250 235Ã—185": { semi: 13.40, solid: 13.60 },
    "200/300 280Ã—185": { semi: 14.30, solid: 14.50 }
  };

  const HANDS_FACTOR = { 1:0.6, 2:1.0, 3:1.4 };

  // Add-on: ×©×™× ×•×™ ×’×•×•×Ÿ fixed price 500â‚ª
  const EXTRA_TINT = { name: "×©×™× ×•×™ ×’×•×•×Ÿ", price: 500 };

  // ==== State ====
  let total = 0;
  const tbody = document.getElementById("tableBody");
  const itemSelect = document.getElementById("item");

  // Fill select
  Object.keys(PRICE_LIST).forEach(name => {
    const o = document.createElement("option");
    o.value = name;
    o.textContent = name;
    itemSelect.appendChild(o);
  });

  // ==== UI Functions ====
  function openModal(){ modal.style.display="flex"; }
  function closeModal(){ modal.style.display="none"; }

  function updateTotalUI() {
    document.getElementById("grandTotal").innerText = total.toFixed(2);
  }

  function addRow(){
    const item = itemSelect.value;
    const colorVal = document.getElementById("color").value;
    const hands = Number(document.getElementById("hands").value);
    const qty = Number(document.getElementById("qty").value);
    const len = Number(document.getElementById("len").value);

    if(qty<=0 || len<=0){ alert("× × ×œ×”×–×™×Ÿ ×¢×¨×›×™× ×ª×§×™× ×™×"); return; }

    const pricePerMeter = PRICE_LIST[item][colorVal];
    const totalMeters = qty * len;
    const rowPrice = totalMeters * pricePerMeter * HANDS_FACTOR[hands];

    total += rowPrice;
    updateTotalUI();

    const tr = document.createElement("tr");
    tr.dataset.price = String(rowPrice);
    tr.dataset.item = item;
    tr.dataset.hands = String(hands);
    tr.dataset.qty = String(qty);
    tr.dataset.len = String(len);
    tr.dataset.meters = String(totalMeters.toFixed(2));

    tr.innerHTML = `
      <td dir="rtl">${formatItemHTML(item)}</td>
      <td>${hands}</td>
      <td>${qty}</td>
      <td>${len}</td>
      <td>${totalMeters.toFixed(2)}</td>
      <td>${rowPrice.toFixed(2)}</td>
      <td><button class="delete-btn" title="××—×™×§×”">ğŸ—‘ï¸</button></td>
    `;

    tr.querySelector(".delete-btn").onclick = () => {
      total -= Number(tr.dataset.price || "0");
      updateTotalUI();
      tr.remove();
    };

    tbody.appendChild(tr);
    closeModal();
  }

  // Add-on button: ×©×™× ×•×™ ×’×•×•×Ÿ (500â‚ª)
  (function addTintButton(){
    const btn = document.createElement("button");
    btn.className = "secondary";
    btn.style.marginInlineStart = "10px";
    btn.textContent = "ğŸ¨ ×©×™× ×•×™ ×’×•×•×Ÿ (+500â‚ª)";
    btn.onclick = () => {
      // prevent duplicates: only one tint row
      const exists = [...tbody.querySelectorAll("tr")].some(r => r.dataset.type === "tint");
      if (exists) return;

      const tr = document.createElement("tr");
      tr.dataset.type = "tint";
      tr.dataset.price = String(EXTRA_TINT.price);
      tr.dataset.item = EXTRA_TINT.name;

      total += EXTRA_TINT.price;
      updateTotalUI();

      tr.innerHTML = `
        <td dir="rtl">${EXTRA_TINT.name}</td>
        <td>â€”</td>
        <td>1</td>
        <td>â€”</td>
        <td>â€”</td>
        <td>${EXTRA_TINT.price.toFixed(2)}</td>
        <td><button class="delete-btn" title="××—×™×§×”">ğŸ—‘ï¸</button></td>
      `;

      tr.querySelector(".delete-btn").onclick = () => {
        total -= EXTRA_TINT.price;
        updateTotalUI();
        tr.remove();
      };

      tbody.prepend(tr);
    };

    // insert next to "×”×•×¡×£ ×¤×¨×™×˜"
    const addBtn = document.querySelector('button.primary[onclick="openModal()"]');
    addBtn.insertAdjacentElement("afterend", btn);
  })();

  function generatePDF(){
    pdfName.innerText  = customerName.value  || "â€”";
    pdfId.innerText    = customerId.value    || "â€”";
    pdfEmail.innerText = customerEmail.value || "â€”";
    pdfDate.innerText  = new Date().toLocaleDateString("he-IL");
    pdfTotal.innerText = total.toFixed(2);
    pdfOrderId.innerText = makeOrderId();

    const pdfTable = document.getElementById("pdfTable");
    pdfTable.innerHTML = "";

    // Build PDF rows from dataset (no innerText issues / keeps correct formatting)
    document.querySelectorAll("#tableBody tr").forEach(row => {
      const tr = document.createElement("tr");

      // tint row
      if (row.dataset.type === "tint") {
        tr.innerHTML = `
          <td dir="rtl">${row.dataset.item}</td>
          <td>â€”</td>
          <td>1</td>
          <td>â€”</td>
          <td>â€”</td>
          <td>${Number(row.dataset.price).toFixed(2)}</td>
        `;
        pdfTable.appendChild(tr);
        return;
      }

      const item = row.dataset.item || "";
      const hands = row.dataset.hands || "";
      const qty = row.dataset.qty || "";
      const len = row.dataset.len || "";
      const meters = row.dataset.meters || "";
      const price = Number(row.dataset.price || "0").toFixed(2);

      tr.innerHTML = `
        <td dir="rtl">${formatItemHTML(item)}</td>
        <td>${hands}</td>
        <td>${qty}</td>
        <td>${len}</td>
        <td>${meters}</td>
        <td>${price}</td>
      `;
      pdfTable.appendChild(tr);
    });

    // Show -> render -> hide
    pdfWrap.style.display = "block";

    const element = document.getElementById("pdfContent");
    const filename = `×”×¦×¢×ª_××—×™×¨_${pdfOrderId.innerText}.pdf`;

    html2pdf()
      .set({
        filename,
        margin: 0,
        pagebreak: { mode: ["css", "legacy"] },
        jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
        html2canvas: { scale: 2, useCORS: true, backgroundColor: "#ffffff" }
      })
      .from(element)
      .save()
      .finally(() => { pdfWrap.style.display = "none"; });
  }

  // Expose for inline onclick
  window.openModal = openModal;
  window.closeModal = closeModal;
  window.addRow = addRow;
  window.generatePDF = generatePDF;
</script>

</body>
</html>
